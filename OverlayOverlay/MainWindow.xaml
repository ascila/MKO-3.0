<Window x:Class="OverlayOverlay.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Overlay" Width="620" SizeToContent="Manual"
        WindowStyle="None" ResizeMode="CanResizeWithGrip"
        AllowsTransparency="True" Background="#AA000000"
        Topmost="True" ShowInTaskbar="True" WindowStartupLocation="CenterScreen"
        Loaded="Window_Loaded" MouseDown="Window_MouseDown" LocationChanged="Window_LocationChanged">
  <Window.Resources>
    <BooleanToVisibilityConverter x:Key="BoolToVis"/>
  </Window.Resources>
  <Border CornerRadius="10" Background="{DynamicResource BgBrush}" BorderBrush="#33000000" BorderThickness="1" Padding="10">
    <Grid>
      <Grid.RowDefinitions>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="Auto"/>
        <RowDefinition Height="Auto"/>
      </Grid.RowDefinitions>

      <!-- Fila 1: Barra superior con asa + audio + settings/close -->
      <Grid Grid.Row="0">
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="14"/>
          <ColumnDefinition Width="*"/>
          <ColumnDefinition Width="Auto"/>
        </Grid.ColumnDefinitions>
        <Grid Grid.Column="0" Cursor="SizeAll" MouseDown="Window_MouseDown"/>
        <!-- Audio + idioma (ES/EN) -->
        <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
          <ToggleButton x:Name="AudioMonitorToggle" ToolTip="System audio" Style="{StaticResource MonitorToggleStyle}" Click="AudioMonitorToggle_Click">
            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE7F8;" FontSize="12" VerticalAlignment="Center" HorizontalAlignment="Center"/>
          </ToggleButton>
          <Border x:Name="SysLevelBar" Width="48" Height="8" Margin="6,0,10,0" Background="#202020" CornerRadius="4">
            <Border x:Name="SysFill" Width="0" Height="8" Background="#10B981" CornerRadius="4"/>
          </Border>
          <ToggleButton x:Name="MicMonitorToggle" ToolTip="Microphone" Style="{StaticResource MonitorToggleStyle}" Click="MicMonitorToggle_Click">
            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE720;" FontSize="12" VerticalAlignment="Center" HorizontalAlignment="Center"/>
          </ToggleButton>
          <Border x:Name="MicLevelBar" Width="48" Height="8" Margin="6,0,0,0" Background="#202020" CornerRadius="4">
            <Border x:Name="MicFill" Width="0" Height="8" Background="#10B981" CornerRadius="4"/>
          </Border>
          <!-- Nudge buttons: move window by one screen third -->
          <Button x:Name="BtnNudgeLeft" Width="36" Height="28" Margin="12,0,0,0" ToolTip="Move left by one third" Click="NudgeLeft_Click">
            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE76B;" FontSize="14" VerticalAlignment="Center" HorizontalAlignment="Center"/>
          </Button>
          <Button x:Name="BtnNudgeRight" Width="36" Height="28" Margin="6,0,0,0" ToolTip="Move right by one third" Click="NudgeRight_Click">
            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE76C;" FontSize="14" VerticalAlignment="Center" HorizontalAlignment="Center"/>
          </Button>
          <!-- (Idioma movido a segunda fila) -->
        </StackPanel>

        <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
          <Button x:Name="BackButton" Height="36" MinWidth="100" Margin="0,0,6,0" Style="{StaticResource DangerButtonStyle}"
                  Padding="16,8" Click="BackToSetup_Click" ToolTip="Back to Setup">Back</Button>
          <Button x:Name="SettingsButton" Width="36" Height="36" Margin="8,0,0,0" Click="SettingsButton_Click" ToolTip="Settings">
            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE713;" FontSize="16" VerticalAlignment="Center" HorizontalAlignment="Center"/>
          </Button>
          <Button Width="36" Height="36" Margin="6,0,0,0" Click="Close_Click" ToolTip="Close">
            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8BB;" FontSize="16" VerticalAlignment="Center" HorizontalAlignment="Center"/>
          </Button>
        </StackPanel>
      </Grid>

      <!-- Fila 2: Start + idiomas + Clear + Project Mode -->
      <UniformGrid Grid.Row="1" Rows="1" Columns="5" Margin="0,8,0,0" VerticalAlignment="Center">
        <Button x:Name="BtnStart" Height="33" Padding="14,8" Click="StartStop_Click">
          <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE768;" Margin="0,0,6,0"/>
            <TextBlock Text="Start"/>
          </StackPanel>
        </Button>
        <Button Height="33" Padding="14,8">
          <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE74D;" Margin="0,0,6,0"/>
            <TextBlock Text="Clear Transcript"/>
          </StackPanel>
        </Button>
        <!-- Project Mode como botÃ³n normal, separaciÃ³n simÃ©trica por estilo base -->
        <Button x:Name="BtnProjectMode" Height="33">
          <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE7B8;" Margin="0,0,6,0"/>
            <TextBlock Text="Project Mode"/>
          </StackPanel>
        </Button>
        <!-- Idioma: EN primero, luego ES -->
        <ToggleButton x:Name="LangEN" Content="EN" Style="{StaticResource LangToggleStyle}" Click="LangToggle_Click" Height="33" IsChecked="True"/>
        <ToggleButton x:Name="LangES" Content="ES" Style="{StaticResource LangToggleStyle}" Click="LangToggle_Click" Height="33" IsChecked="False"/>
      </UniformGrid>

      <!-- Fila 3: acciones principales -->
      <WrapPanel Grid.Row="2" Margin="0,8,0,0" VerticalAlignment="Center" HorizontalAlignment="Center" Orientation="Horizontal" >
        <Button x:Name="BtnCapture" MinWidth="190" Height="33" Style="{StaticResource PrimaryButtonStyle}" Click="CaptureQuestion_Click">
          <Grid>
            <!-- Spinner shown during capture: single dotted ring -->
            <Grid x:Name="CaptureSpinner" Visibility="Collapsed" HorizontalAlignment="Center" VerticalAlignment="Center">
              <Viewbox Width="20" Height="20">
                <Grid Width="20" Height="20">
                  <Ellipse Stroke="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}"
                           StrokeThickness="3"
                           StrokeDashArray="1 2"
                           StrokeDashCap="Round"
                           Fill="Transparent"
                           Width="18" Height="18">
                    <Ellipse.RenderTransform>
                      <RotateTransform x:Name="CaptureRotate" Angle="0" CenterX="9" CenterY="9"/>
                    </Ellipse.RenderTransform>
                  </Ellipse>
                </Grid>
              </Viewbox>
            </Grid>

            <!-- Default label -->
            <StackPanel x:Name="CaptureLabel" Orientation="Horizontal" VerticalAlignment="Center">
              <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE7C0;" Margin="0,0,8,0"/>
              <TextBlock Text="Capture"/>
            </StackPanel>
          </Grid>
        </Button>
        <Button x:Name="BtnAnalyze" MinWidth="210" Height="33" Style="{StaticResource PrimaryButtonStyle}" Click="Analyze_Click">
          <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE721;" Margin="0,0,8,0"/>
            <TextBlock Text="Analyze Screen"/>
          </StackPanel>
        </Button>
        <Button x:Name="BtnFollowUp" MinWidth="140" Height="33" Margin="8,0,0,0" Click="FollowUp_Click">
          <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
            <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8FA;" Margin="0,0,8,0"/>
            <TextBlock Text="Follow-up"/>
          </StackPanel>
        </Button>
        <!-- Removed legacy Regenerate button in header -->
      </WrapPanel>

      <!-- Fila 4: Panels for Last Question and Live Transcription -->
      <Grid x:Name="SectionsHost" Grid.Row="3" Margin="0,8,0,0">
        <Grid.RowDefinitions>
          <RowDefinition x:Name="RowQnA" Height="3*"/>
          <RowDefinition x:Name="RowLive" Height="*"/>
          <RowDefinition x:Name="RowDebug" Height="*"/>
        </Grid.RowDefinitions>
        <!-- Interview Q&A Panel (hidden to avoid duplication; use history below) -->
        <Border x:Name="InterviewPanel" Visibility="Collapsed" Background="{DynamicResource BgBrush}" BorderBrush="#33000000" BorderThickness="1" CornerRadius="8" Padding="10" Margin="0,0,0,8">
          <StackPanel>
            <DockPanel LastChildFill="False">
              <StackPanel Orientation="Vertical" DockPanel.Dock="Left">
                <TextBlock Text="Interview Q&amp;A" FontWeight="Bold"/>
                <TextBlock Text="AI-extracted question from the transcript." Opacity="0.8" FontSize="12"/>
              </StackPanel>
              <Button x:Name="BtnCopyQuestion" DockPanel.Dock="Right" Width="32" Height="28" ToolTip="Copy last question" Click="CopyQuestion_Click">
                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8C8;" HorizontalAlignment="Center" VerticalAlignment="Center"/>
              </Button>
            </DockPanel>
            <Border Background="#1212120F" CornerRadius="6" Padding="8" Margin="0,6,0,0">
              <TextBlock x:Name="LastQuestionText" Text="No questions asked yet." TextWrapping="Wrap"/>
            </Border>
          </StackPanel>
        </Border>

        <!-- Q&A History (collapsible) -->
        <Expander x:Name="QnASection" Grid.Row="0" Background="{DynamicResource BgBrush}" BorderBrush="#33000000" BorderThickness="1"
                  Padding="10" Margin="0,0,0,8" IsExpanded="True"
                  Style="{StaticResource QnACardExpanderStyle}">
          <Expander.Header>
            <Grid x:Name="QnAHeader" Margin="0,0,0,6">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="28"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
              </Grid.ColumnDefinitions>
              <!-- Toggle -->
              <ToggleButton Width="28" Height="28" Grid.Column="0"
                            Style="{StaticResource BaseButtonStyle}"
                            Margin="0"
                            Padding="0"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Center"
                            IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource AncestorType=Expander}, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                <ToggleButton.Resources>
                  <Style TargetType="TextBlock">
                    <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
                    <Setter Property="RenderTransform">
                      <Setter.Value>
                        <RotateTransform Angle="0"/>
                      </Setter.Value>
                    </Setter>
                    <Style.Triggers>
                      <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}}" Value="True">
                        <Setter Property="RenderTransform">
                          <Setter.Value>
                            <RotateTransform Angle="180"/>
                          </Setter.Value>
                        </Setter>
                      </DataTrigger>
                    </Style.Triggers>
                  </Style>
                </ToggleButton.Resources>
                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE70D;" HorizontalAlignment="Center" VerticalAlignment="Center"/>
              </ToggleButton>
              <!-- Title -->
              <StackPanel Grid.Column="1" Orientation="Vertical" Margin="8,0,0,0" VerticalAlignment="Center">
                <TextBlock Text="Q&amp;A History" FontWeight="Bold"/>
              </StackPanel>
              <!-- Action right -->
              <Button x:Name="BtnCopyAllQuestions" Grid.Column="2" Width="32" Height="28" Margin="0" VerticalAlignment="Center" HorizontalAlignment="Right" ToolTip="Copy all questions" Click="CopyAllQuestions_Click">
                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8C8;" HorizontalAlignment="Center" VerticalAlignment="Center"/>
              </Button>
            </Grid>
          </Expander.Header>
          <Grid>
            <ScrollViewer x:Name="QnAScroll" VerticalScrollBarVisibility="Auto" Margin="0,6,0,0" VerticalAlignment="Stretch" PanningMode="VerticalFirst" CanContentScroll="False">
              <StackPanel x:Name="QnAHistoryItems" />
            </ScrollViewer>
          </Grid>
          </Expander>

        <!-- Live Transcription Panel (collapsible) -->
        <Expander x:Name="LiveSection" Grid.Row="1" Background="{DynamicResource BgBrush}" BorderBrush="#33000000" BorderThickness="1"
                  Padding="10" IsExpanded="True"
                  Style="{StaticResource QnACardExpanderStyle}">
          <Expander.Header>
            <Grid x:Name="LiveHeader" Margin="0,0,0,6">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="28"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
              </Grid.ColumnDefinitions>
              <ToggleButton Width="28" Height="28" Grid.Column="0"
                             Style="{StaticResource BaseButtonStyle}"
                             Margin="0"
                             Padding="0"
                             HorizontalAlignment="Left"
                             VerticalAlignment="Center"
                             IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource AncestorType=Expander}, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                 <ToggleButton.Resources>
                  <Style TargetType="TextBlock">
                    <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
                    <Setter Property="RenderTransform">
                      <Setter.Value>
                        <RotateTransform Angle="0"/>
                      </Setter.Value>
                    </Setter>
                    <Style.Triggers>
                      <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}}" Value="True">
                        <Setter Property="RenderTransform">
                          <Setter.Value>
                            <RotateTransform Angle="180"/>
                          </Setter.Value>
                        </Setter>
                      </DataTrigger>
                    </Style.Triggers>
                  </Style>
                </ToggleButton.Resources>
                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE70D;" HorizontalAlignment="Center" VerticalAlignment="Center"/>
              </ToggleButton>
              <StackPanel Grid.Column="1" Orientation="Vertical" Margin="8,0,0,0" VerticalAlignment="Center">
                <TextBlock Text="Live Transcription" FontWeight="Bold"/>
              </StackPanel>
              <!-- Action right: copy all transcription -->
              <Button x:Name="BtnCopyLive" Grid.Column="2" Width="32" Height="28" Margin="0" VerticalAlignment="Center" HorizontalAlignment="Right" ToolTip="Copy transcription" Click="CopyLive_Click">
                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8C8;" HorizontalAlignment="Center" VerticalAlignment="Center"/>
              </Button>
            </Grid>
          </Expander.Header>
          <Grid>
            <Border Background="#1212120F" CornerRadius="6" Padding="8" Margin="0,6,0,0">
              <ScrollViewer x:Name="LiveScroll" VerticalScrollBarVisibility="Auto" VerticalAlignment="Stretch" PanningMode="VerticalFirst" CanContentScroll="False">
                <TextBlock x:Name="LiveTranscriptBox" Text="Waiting for audio..." TextWrapping="Wrap"/>
              </ScrollViewer>
            </Border>
          </Grid>
        </Expander>

        <!-- Debug Log Panel (toggleable + collapsible) -->
        <Expander x:Name="DebugSection" Grid.Row="2" Background="{DynamicResource BgBrush}" BorderBrush="#33000000" BorderThickness="1"
                  Padding="10" Margin="0,8,0,0"
                  Visibility="{Binding IsChecked, ElementName=DebugToggle, Converter={StaticResource BoolToVis}}"
                  IsExpanded="True" Style="{StaticResource QnACardExpanderStyle}">
          <Expander.Header>
            <Grid x:Name="DebugHeader" Margin="0,0,0,6">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="28"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
              </Grid.ColumnDefinitions>
              <ToggleButton Width="28" Height="28" Grid.Column="0"
                            Style="{StaticResource BaseButtonStyle}"
                            Margin="0"
                            Padding="0"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Center"
                            IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource AncestorType=Expander}, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}">
                <ToggleButton.Resources>
                  <Style TargetType="TextBlock">
                    <Setter Property="RenderTransformOrigin" Value="0.5,0.5"/>
                    <Setter Property="RenderTransform">
                      <Setter.Value>
                        <RotateTransform Angle="0"/>
                      </Setter.Value>
                    </Setter>
                    <Style.Triggers>
                      <DataTrigger Binding="{Binding IsChecked, RelativeSource={RelativeSource AncestorType=ToggleButton}}" Value="True">
                        <Setter Property="RenderTransform">
                          <Setter.Value>
                            <RotateTransform Angle="180"/>
                          </Setter.Value>
                        </Setter>
                      </DataTrigger>
                    </Style.Triggers>
                  </Style>
                </ToggleButton.Resources>
                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE70D;" HorizontalAlignment="Center" VerticalAlignment="Center"/>
              </ToggleButton>
              <StackPanel Grid.Column="1" Orientation="Vertical" Margin="8,0,0,0" VerticalAlignment="Center">
                <TextBlock Text="Debug Logs" FontWeight="Bold"/>
              </StackPanel>
              <Button x:Name="BtnCopyLogs" Grid.Column="2" Width="32" Height="28" VerticalAlignment="Center" ToolTip="Copy logs" Click="CopyLogs_Click">
                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE8C8;" HorizontalAlignment="Center" VerticalAlignment="Center"/>
              </Button>
              <Button x:Name="BtnTestAzure" Grid.Column="3" Width="32" Height="28" Margin="6,0,0,0" VerticalAlignment="Center" ToolTip="Test Azure auth" Click="TestAzure_Click">
                <TextBlock FontFamily="Segoe MDL2 Assets" Text="&#xE774;" HorizontalAlignment="Center" VerticalAlignment="Center"/>
              </Button>
            </Grid>
          </Expander.Header>
          <Grid>
            <Border Background="#1212120F" CornerRadius="6" Padding="8" Margin="0,6,0,0">
              <ScrollViewer x:Name="DebugScroll" VerticalScrollBarVisibility="Auto" VerticalAlignment="Stretch" PanningMode="VerticalFirst" CanContentScroll="False">
                <TextBox x:Name="DebugLogBox" IsReadOnly="True" TextWrapping="Wrap" AcceptsReturn="True" FontFamily="Consolas" MinHeight="120"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"/>
              </ScrollViewer>
            </Border>
          </Grid>
        </Expander>
      </Grid>

      <!-- MenÃº de configuraciÃ³n -->
      <Popup x:Name="SettingsPopup" PlacementTarget="{Binding ElementName=SettingsButton}" Placement="Bottom" StaysOpen="False" AllowsTransparency="True" Opened="SettingsPopup_Opened">
        <Border Background="{DynamicResource BgBrush}" BorderBrush="#33000000" BorderThickness="1" CornerRadius="8" Padding="8" >
          <StackPanel>
            <TextBlock Text="Opacity" Margin="2,0,2,4"/>
            <Slider x:Name="OpacitySlider" Minimum="0.2" Maximum="1.0" Value="0.9" Width="220" ValueChanged="OpacitySlider_ValueChanged"/>
            <Separator Margin="0,6,0,6"/>
            <TextBlock Text="Theme" Margin="2,0,2,4"/>
            <StackPanel Orientation="Horizontal">
              <RadioButton x:Name="ThemeLight" Content="Light" GroupName="Theme" Margin="0,0,8,0" Checked="ThemeRadio_Checked"/>
              <RadioButton x:Name="ThemeDark" Content="Dark" GroupName="Theme" Checked="ThemeRadio_Checked"/>
            </StackPanel>
            <Separator Margin="0,6,0,6"/>
            <TextBlock Text="Microphone" Margin="2,0,2,4"/>
            <ComboBox x:Name="MicDeviceCombo" Width="220" SelectionChanged="MicDeviceCombo_SelectionChanged"/>
            <Separator Margin="0,6,0,6"/>
            <CheckBox x:Name="DebugToggle" Content="Show Debug Panel" IsChecked="True"/>
            <Separator Margin="0,6,0,6"/>
            <CheckBox x:Name="ExcludeFromCaptureToggle" Content="Hide window in screen captures" IsChecked="False"/>
          </StackPanel>
        </Border>
      </Popup>
    </Grid>
  </Border>
</Window>
